<section class="hero">
  <h1>Slow letters, lasting resonance</h1>
  <p>Write slow, read slow. Letters steep for 12 hours. No rush, no noise.</p>
  <div class="hero-ctas">
    <% if (user) { %>
      <a class="btn btn-primary" href="/compose">Compose a letter</a>
    <% } else { %>
      <a class="btn btn-primary" href="/signup">Create account</a>
      <a class="btn btn-ghost" href="/login">Sign in</a>
    <% } %>
  </div>
</section>

<section class="features container">
  <div class="feature">
    <h3>12-hour steep</h3>
    <p>Space to reflect. Letters publish after a gentle pause.</p>
  </div>
  <div class="feature">
    <h3>One a day</h3>
    <p>Quality over quantity. Intentional writing, not infinite scroll.</p>
  </div>
  <div class="feature">
    <h3>No scores</h3>
    <p>Resonate quietly. No public counters or popularity contests.</p>
  </div>
  <div class="feature">
    <h3>Thoughtful replies</h3>
    <p>One response per reader per letter keeps threads calm.</p>
  </div>
</section>

<section class="feed">
  <h2 class="section-title">Latest letters</h2>
  <% if (letters.length === 0) { %>
    <p class="empty">No letters yet. Come back later.</p>
  <% } %>
  <% letters.forEach(letter => { %>
    <article class="letter">
      <h2><a href="/letters/<%= letter.id %>"><%= letter.title %></a></h2>
      <div class="meta"><%= new Date(letter.publish_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></div>
      <p><%= letter.body.slice(0, 260) %><% if (letter.body.length > 260) { %>â€¦<% } %></p>
      
      <!-- Author section -->
      <div class="feed-author">
        <div class="feed-author-avatar">
          <% if (letter.avatar_url) { %>
            <img src="<%= letter.avatar_url %>" alt="<%= letter.handle %>" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\"font-size:16px\">ðŸ‘¤</span>';">
          <% } else { %>
            <span style="font-size: 16px;">ðŸ‘¤</span>
          <% } %>
        </div>
        <div class="feed-author-info">
          <div class="feed-author-name">@<%= letter.handle %></div>
          <% if (letter.bio) { %>
            <div class="feed-author-bio"><%= letter.bio.slice(0, 100) %><% if (letter.bio.length > 100) { %>â€¦<% } %></div>
          <% } %>
        </div>
      </div>
      
      <div class="actions">
        <% if (user) { %>
          <div class="reading-actions">
            <% if (letter.reading_status === 'read') { %>
              <button class="reading-btn read completed" disabled>
                <span class="icon">âœ“</span> Read
              </button>
            <% } else if (letter.reading_status === 'skip') { %>
              <button class="reading-btn skip completed" disabled>
                <span class="icon">â†’</span> Skipped
              </button>
            <% } else if (letter.reading_status === 'later') { %>
              <button class="reading-btn later active" onclick="updateReadingStatus(<%= letter.id %>, 'remove')">
                <span class="icon">ðŸ”–</span> Saved
              </button>
            <% } else { %>
              <button class="reading-btn read" onclick="window.location.href='/letters/<%= letter.id %>'">
                <span class="icon">ðŸ“–</span> Read
              </button>
              <button class="reading-btn skip" onclick="updateReadingStatus(<%= letter.id %>, 'skip')">
                <span class="icon">â†’</span> Skip
              </button>
              <button class="reading-btn later" onclick="updateReadingStatus(<%= letter.id %>, 'later')">
                <span class="icon">ðŸ”–</span> Later
              </button>
            <% } %>
          </div>
          
          <div class="resonate-action">
            <% if (letter.did_resonate) { %>
              <form action="/letters/<%= letter.id %>/unresonate" method="post"><input type="hidden" name="_csrf" value="<%= csrfToken %>" /><button class="btn resonate-btn active">Resonated</button></form>
            <% } else { %>
              <form action="/letters/<%= letter.id %>/resonate" method="post"><input type="hidden" name="_csrf" value="<%= csrfToken %>" /><button class="btn resonate-btn">Resonate</button></form>
            <% } %>
          </div>
        <% } %>
      </div>
    </article>
  <% }) %>

  <div class="pagination">
    <% if (page > 1) { %>
      <a class="btn" href="/?page=<%= page - 1 %>">Previous</a>
    <% } %>
    <a class="btn" href="/?page=<%= page + 1 %>">Next</a>
  </div>
</section>

<script>
function updateReadingStatus(letterId, status) {
  fetch(`/letters/${letterId}/status`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': '<%= csrfToken %>'
    },
    body: JSON.stringify({ status })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Reload to update UI
      window.location.reload();
    } else {
      alert('Failed to update reading status');
    }
  })
  .catch(err => {
    console.error('Error:', err);
    alert('Failed to update reading status');
  });
}
</script>


