<%- include('layout', { title: 'Browse Tags' }) %>

<style>
  .tags-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
  }
  
  .tags-header {
    margin-bottom: 2rem;
  }
  
  .tags-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }
  
  .tags-header p {
    color: #666;
    margin-bottom: 1rem;
  }
  
  .alert {
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 4px;
  }
  
  .alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
  
  .tags-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }
  
  .tag-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    transition: box-shadow 0.2s;
  }
  
  .tag-card:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .tag-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
  }
  
  .tag-name {
    font-size: 1.25rem;
    font-weight: bold;
    color: #333;
    margin: 0;
  }
  
  .tag-visibility {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  
  .tag-public {
    background-color: #28a745;
    color: white;
  }
  
  .tag-private {
    background-color: #dc3545;
    color: white;
  }
  
  .tag-description {
    color: #666;
    margin-bottom: 1rem;
    min-height: 2.5rem;
  }
  
  .tag-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
    color: #666;
  }
  
  .tag-stat {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .tag-owners {
    margin-bottom: 1rem;
    font-size: 0.875rem;
  }
  
  .tag-owners-label {
    font-weight: 500;
    margin-bottom: 0.25rem;
  }
  
  .owner-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .owner-badge {
    background-color: #f0f0f0;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
  }
  
  .owner-badge.founder {
    background-color: #ffd700;
    color: #333;
  }
  
  .tag-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.875rem;
    transition: opacity 0.2s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }
  
  .btn:hover {
    opacity: 0.9;
  }
  
  .btn-primary {
    background-color: #007bff;
    color: white;
  }
  
  .btn-success {
    background-color: #28a745;
    color: white;
  }
  
  .btn-warning {
    background-color: #ffc107;
    color: #333;
  }
  
  .btn-danger {
    background-color: #dc3545;
    color: white;
  }
  
  .btn-secondary {
    background-color: #6c757d;
    color: white;
  }
  
  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .has-access {
    color: #28a745;
    font-weight: 500;
  }
  
  .pending-request {
    color: #ffc107;
    font-weight: 500;
  }
  
  .request-form {
    display: none;
    margin-top: 1rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 4px;
  }
  
  .request-form.active {
    display: block;
  }
  
  .form-group {
    margin-bottom: 1rem;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 500;
  }
  
  .form-group textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: vertical;
    min-height: 80px;
  }
  
  .form-actions {
    display: flex;
    gap: 0.5rem;
  }
</style>

<div class="tags-container">
  <div class="tags-header">
    <h1>Browse Tags</h1>
    <p>Explore available tags and request access to view tagged content</p>
    
    <% if (message) { %>
      <div class="alert alert-success"><%= message %></div>
    <% } %>
    
    <% if (error) { %>
      <div class="alert alert-error"><%= error %></div>
    <% } %>
  </div>
  
  <div class="tags-grid">
    <% tags.forEach(tag => { %>
      <div class="tag-card">
        <div class="tag-header">
          <h2 class="tag-name">#<%= tag.name %></h2>
          <span class="tag-visibility <%= tag.is_public ? 'tag-public' : 'tag-private' %>">
            <%= tag.is_public ? 'Public' : 'Private' %>
          </span>
        </div>
        
        <p class="tag-description">
          <%= tag.description || 'No description available' %>
        </p>
        
        <div class="tag-stats">
          <div class="tag-stat">
            üìù <%= tag.letter_count || 0 %> letters
          </div>
          <div class="tag-stat">
            üë• <%= tag.owner_count || 0 %> owner<%= tag.owner_count !== 1 ? 's' : '' %>
          </div>
          <div class="tag-stat">
            üî¢ Used <%= tag.usage_count || 0 %> times
          </div>
        </div>
        
        <% if (tag.owners && tag.owners.length > 0) { %>
          <div class="tag-owners">
            <div class="tag-owners-label">Managed by:</div>
            <div class="owner-list">
              <% tag.owners.slice(0, 3).forEach(owner => { %>
                <span class="owner-badge <%= owner.ownership_type %>">
                  @<%= owner.handle %>
                  <% if (owner.ownership_type === 'founder') { %>
                    üëë
                  <% } %>
                </span>
              <% }) %>
              <% if (tag.owners.length > 3) { %>
                <span class="owner-badge">+<%= tag.owners.length - 3 %> more</span>
              <% } %>
            </div>
          </div>
        <% } %>
        
        <div class="tag-actions">
          <% if (user) { %>
            <% if (tag.is_owner) { %>
              <a href="/tags/<%= tag.id %>/manage" class="btn btn-warning">
                ‚öôÔ∏è Manage
              </a>
            <% } else if (tag.has_access) { %>
              <span class="has-access">‚úÖ You have access</span>
            <% } else if (tag.request_status === 'pending') { %>
              <span class="pending-request">‚è≥ Request pending</span>
              <form action="/tags/<%= tag.id %>/cancel-request" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-secondary">Cancel</button>
              </form>
            <% } else if (tag.request_status === 'rejected') { %>
              <button class="btn btn-primary request-btn" data-tag-id="<%= tag.id %>">
                üîÑ Request Again
              </button>
            <% } else { %>
              <button class="btn btn-primary request-btn" data-tag-id="<%= tag.id %>">
                üîì Request Access
              </button>
            <% } %>
          <% } else { %>
            <a href="/login" class="btn btn-secondary">Login to request access</a>
          <% } %>
        </div>
        
        <% if (user && !tag.has_access && tag.request_status !== 'pending') { %>
          <div class="request-form" id="request-form-<%= tag.id %>">
            <form action="/tags/<%= tag.id %>/request-access" method="POST">
              <div class="form-group">
                <label for="message-<%= tag.id %>">Message to tag owners (optional):</label>
                <textarea 
                  name="message" 
                  id="message-<%= tag.id %>"
                  placeholder="Explain why you'd like access to content with this tag..."
                ></textarea>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-success">Send Request</button>
                <button type="button" class="btn btn-secondary cancel-request-btn" data-tag-id="<%= tag.id %>">
                  Cancel
                </button>
              </div>
            </form>
          </div>
        <% } %>
      </div>
    <% }) %>
  </div>
</div>

<script>
  // Handle request access button clicks
  document.querySelectorAll('.request-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const tagId = this.dataset.tagId;
      const form = document.getElementById(`request-form-${tagId}`);
      if (form) {
        form.classList.add('active');
        this.style.display = 'none';
      }
    });
  });
  
  // Handle cancel button clicks
  document.querySelectorAll('.cancel-request-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const tagId = this.dataset.tagId;
      const form = document.getElementById(`request-form-${tagId}`);
      const requestBtn = document.querySelector(`.request-btn[data-tag-id="${tagId}"]`);
      if (form) {
        form.classList.remove('active');
      }
      if (requestBtn) {
        requestBtn.style.display = '';
      }
    });
  });
</script>
